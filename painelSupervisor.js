const ADM = [
        {
            id: 131,
            nome: "ASLEY RODRIGO DE MELO LIMA",
            nomeTLC: "asley",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 94,
            nome: "CARLOS HENRIQUE ESPASIANI",
            nomeTLC: "henrique",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 204,
            nome: "DIEGO DOS SANTOS SILVA",
            nomeTLC: "diego",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 197,
            nome: "JHONATHAN DA FONSECA ALMEIDA FLOR",
            nomeTLC: "jhonathan",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 51,
            nome: "JULIANO OLIVEIRA DE SOUZA",
            nomeTLC: "juliano",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 196,
            nome: "KAUÃ DE CARVALHO NASCIMENTO",
            nomeTLC: "kauã",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 64,
            nome: "LEANDRO SANTOS",
            nomeTLC: "leandro",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 221,
            nome: "LEONARDO TEIXEIRA SANTOS SILVA",
            nomeTLC: "leonardo",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 199,
            nome: "LUCAS NATHAN NOGUEIRA DA SILVA",
            nomeTLC: "lucas",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 198,
            nome: "MURILLO VICTOR SANTOS ROCHA",
            nomeTLC: "murilo",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 203,
            nome: "RENATA DE JESUS SANTOS",
            nomeTLC: "renata",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 188,
            nome: "VINICIUS SOUSA BOMFIM",
            nomeTLC: "vinicius",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 161,
            nome: "YURI DIAS PEREIRA",
            nomeTLC: "yuri",
            diasViagem: [],
            contagem: 0,
            atrasadas: 0
        },
    ],
    SAC = [
        {
            id: 213,
            nome: "HELLEN VITORIA ROCHA SILVA SANTOS",
            nomeTLC: "hellen",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 205,
            nome: "HELTON FRADES BRABEC SOUZA",
            nomeTLC: "helton",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 62,
            nome: "HENYR GOIS DOS SANTOS",
            nomeTLC: "henyr",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 140,
            nome: "LAYNE DA SILVA GOIS",
            nomeTLC: "layne",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 193,
            nome: "LINIKER BERNARDO SOARES",
            nomeTLC: "liniker",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 201,
            nome: "MARCO AURELIO LEITE GOMES",
            nomeTLC: "marco aurelio",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 217,
            nome: "THIAGO SANTOS SANTANA",
            nomeTLC: "thiago",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 153,
            nome: "TRICYA MATEUS ROLEMBERG",
            nomeTLC: "tricya",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
    ],
    FINANCEIRO = [
        {
            id: 14,
            nome: "ALINE RIBEIRO",
            nomeTLC: "aline",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 216,
            nome: "CAMILA TOJAL MACHADO SANTOS",
            nomeTLC: "camila",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 11,
            nome: "LUCIANA DOS SANTOS ARAUJO",
            nomeTLC: "luciana araujo",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 127,
            nome: "LUCIANA LIMA REZENDE",
            nomeTLC: "luciana lima",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 148,
            nome: "OVERLANDIA SANTOS MELO",
            nomeTLC: "overlandia",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 207,
            nome: "SHEYLA SANTANA SANTOS",
            nomeTLC: "sheyla",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 120,
            nome: "VICTOR MENDES DOS SANTOS",
            nomeTLC: "victor",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
    ],
    INSS = [
        {
            id: 132,
            nome: "DANIEL CABRAL PEREIRA SANTOS",
            nomeTLC: "daniel",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 139,
            nome: "FLAVIO LUCAS LIMA SOUZA",
            nomeTLC: "flavio",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 115,
            nome: "GABRIEL FRANÇA VITAL",
            nomeTLC: "gabriel",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 162,
            nome: "MIQUEAS CAMPOS DA SILVA",
            nomeTLC: "miqueas",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 154,
            nome: "OSMAR SILVA VIANA",
            nomeTLC: "osmar",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },
        {
            id: 24,
            nome: "SILVANIA PINHEIRO DE LEMOS",
            nomeTLC: "silvania",
            diasViagem: null,
            contagem: 0,
            atrasadas: 0
        },

    ]
    /* PREVIDENCIARIO = [],
    TRABALHISTA = [],
    CIVEL = [] */

let updateCount = {
        ADM: ADM.length * 2,
        SAC: SAC.length * 2,
        FINANCEIRO: FINANCEIRO.length * 2,
        INSS: INSS.length * 2,
    },
    percent = {
        ADM: 0,
        SAC: 0,
        FINANCEIRO: 0,
        INSS: 0,
    },
    contIteration = {
        ADM: 0,
        SAC: 0,
        FINANCEIRO: 0,
        INSS: 0,
    }

function createPainel (setor, colaboradores, condiction) {
    if (!condiction) {
        return
    }

    const painelBar = document.querySelector("#fdt-mt-header > ul:nth-child(1)")
    const qtdDias = 8
    const { datas, dias } = getArrayDate(qtdDias)
    const cor = {
        ADM: "azul",
        SAC: "verde",
        FINANCEIRO: "vermelho",
        INSS: "preto",
    }

    const html = `<a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span data-toggle="tooltip" data-placement="bottom" title="Painel do Supervisor ${setor}" data-original-title="Painel do Supervisor ${setor}"><i class="fa fa-fw fa-table fdt-cor-${cor[setor]}"></i></span></a>
                    <ul id="panelSup${setor}" class="dropdown-menu hidden-xs">
                        <li class="fdt-dropdown-cabecalho" style="color: #005689;">Painel do Supervisor</li>
                        <li class="fdt-widget-lembretes">
                            <ul>
                                <li>
                                    ${generateTable(colaboradores, datas, dias)}
                                </li>
                            </ul>
                        </li>
                        <li class="fdt-widget-lembretes" style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 10px 0;">
                            <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                                <span style="background: #34454E; width: 10px; height: 10px;"></span>Tarefas Atrasadas
                            </div>
                            <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                                <span style="background: #A5D5EF; width: 10px; height: 10px;"></span>Tarefas Ativas
                            </div>
                            <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                                <span style="background: #CCC; width: 10px; height: 10px;"></span>Tarefas Encerradas
                            </div>
                            <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                                <span style="background: #ADADAD; width: 10px; height: 10px;"></span>Total de Tarefas
                            </div>
                        </li>
                    </ul>`
                    /* <li class="fdt-dropdown-rodape">
                            <div style="cursor: pointer;">
                                <i class="fa fa-fw fa-refresh"></i>&nbsp;Recarregar Dados
                            </div>
                    </li> */
    const li = document.createElement("li")
    li.innerHTML = html
    li.setAttribute('class', 'dropdown mensagens hidden-xs')
    li.setAttribute('id', `painelBTNSup${setor}`)
    painelBar.appendChild(li)
    const panelSup = document.querySelector(`#panelSup${setor}`)
    const contentBar = createBar(setor)
    panelSup.append(contentBar)
    estilizarTabela()

    
    const inputDados = (nome, result) => {

        const tds = document.querySelectorAll('.tabela td')
        let tdsSeparados = {}
        tdsSeparados[nome] = {}
        tds.forEach(td => {
            if (td.dataset.nome == nome) {
                if (!tdsSeparados[nome][td.dataset.date]) {
                    tdsSeparados[nome][td.dataset.date] = {}
                }
                tdsSeparados[nome][td.dataset.date][td.dataset.categoria] = td
            }
        })

        let chaves = Object.entries(result).map(e => e[0])

        chaves = chaves.filter(chave => (chave != "idTarefas"))

        chaves.forEach(chave => {
            if (chave == 'atrasadas') {
                tdsSeparados[nome]['atrasadas']['atrasadas'].innerHTML = result['atrasadas']
            } else if (result[chave] == 0) {
                tdsSeparados[nome][chave].innerHTML = 0
            } else {
                tdsSeparados[nome][chave]['Ativas'].innerHTML = result[chave]['Ativas']
                tdsSeparados[nome][chave]['Encerradas'].innerHTML = result[chave]['Encerradas']
                tdsSeparados[nome][chave]['Total'].innerHTML = result[chave]['Total']
            }
        })
        incrementBar(setor)
    }
    
    document.querySelector(`#painelBTNSup${setor}`).addEventListener('click', () => {
        showContentBar(contentBar, setor)

        colaboradores.forEach(({ id, nomeTLC }) => {

            const params = `&bsAdvTarefasExecutor=${id}`

            const tarefasAtrasadas = { atrasadas: 0 }

            getTarefasAtrasadas(params, tarefasAtrasadas).then(result => {
                inputDados(nomeTLC, result)
            })

            getTarefasSemanal(id, datas).then(result => {
                inputDados(nomeTLC, result)
            })
        })
    })
}

function generateTable(colaboradores, datas, dias) {
    
    const semana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado']
    let table = `<table class="tabela">`

    for (c = 0; c <= colaboradores.length; c++) {
        table += `<tr>`

        let nome

        if (c > 0) {
            nome = colaboradores[c-1].nomeTLC
        }

        for (let j = 0; j <= datas.length; j++) {
            if ((j == 0) && (c == 0)) {
                table += `<th style="background: rgb(0 86 137);">&nbsp;</th>`
            } else if ((j != 0) && (c == 0)) {
                if (j > 1)
                    table += `<th colspan="3" data-date="${(datas[j-1].toISOString().split('T'))[0]}" class="dRow">${datas[j-1].toLocaleDateString()}<br>${semana[dias[j-1]]}</th>`
                else
                    table += `<th data-date="${datas[j-1]}" class="dRow">Tarefas ${datas[j-1]}</th>`
            } else if ((j == 0) && (c > 0)) {
                table += `<th data-nome="${nome}" class="nCollumn">${nome.toUpperCase()}</th>`
            } else if (c > 0) {
                if (j > 1)
                    table += `<td data-toggle="tooltip" data-original-title="Ativas" data-placement="Top" style="background: #A5D5EF;" data-categoria="Ativas" data-nome="${nome}" data-date="${(datas[j-1].toISOString().split('T'))[0]}">-</td>
                    <td data-toggle="tooltip" data-original-title="Encerradas" data-placement="Top" style="background: #CCC;" data-categoria="Encerradas" data-nome="${nome}" data-date="${(datas[j-1].toISOString().split('T'))[0]}">-</td>
                    <td data-toggle="tooltip" data-original-title="Total" data-placement="Top" style="background: #ADADAD;" data-categoria="Total" data-nome="${nome}" data-date="${(datas[j-1].toISOString().split('T'))[0]}">-</td>`
                else
                    table += `<td style="background: #34454E; color: #FFF;" data-categoria="atrasadas" data-nome="${nome}" data-date="${datas[j-1]}">-</td>`
            }
        }
        table += `</tr>`
    }
    return table
}

function estilizarTabela() {
    const titulos = document.querySelectorAll('.dRow')
    const nomes = document.querySelectorAll('.nCollumn')
    const numbers = document.querySelectorAll('.tabela td')

    const formatTitle = (element) => {
        element.style.padding = '0.5rem'
        element.style.background = '#1c5475'
        element.style.color = '#FFF'
    }
    const formatContent = (element) => {
        element.style.padding = '0.5rem'
        element.style.textAlign = 'center'
        element.style.border = '1px solid lightgray'
    } 

    titulos.forEach(th => {
        th.style.textAlign = 'center'
        formatTitle(th)
    })

    nomes.forEach(th => {
        formatTitle(th)
    })

    numbers.forEach(td => {
        formatContent(td)
    })
}

function getArrayDate (qtdDias) {
    let datas = ['atrasadas'], dias = ['atrasadas']
    let date = new Date()
    cont = 0

    for (c = 1; c <= qtdDias; c++) {
        date.setHours(0,0,0,0)
        let indiceDiaSemana = date.getDay()
        dias.push(indiceDiaSemana)
        datas.push(date)
        date = new Date(date)
        date.setDate(date.getDate()+1)
        cont++
    }

    return { datas, dias }
}

function getTarefasSemanal (id, datas) {
    
    const url = 'http://fabioribeiro.eastus.cloudapp.azure.com/adv/ajax/jsonAgendaTarefas.asp'

    const data = {
        idTI: '',
        idST: '',
        idRE: '',
        idEX: id,
        idAG: '',
        start: datas[1].toISOString().split('T')[0],
        end: datas[datas.length-2].toISOString().split('T')[0],
    }

    const body = JSON.stringify(data).replaceAll('"','').replaceAll(':','=').replaceAll('{','').replaceAll('}','').replaceAll(',','&')

    const result = fetch(url, {
        method: 'POST',
        headers: new Headers({ 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}),
        body
    })
    .then(response => response.text())
    .then(response => {
        let str = response
        str = str.replace(/(\r\n|\n|\r|\t)/gm, "").replaceAll('"',"'")
        if (str.match(/\x07/)) {
            str = str.replace(/\x07/,"")
        }
        let chavesCorretas = ['"id": "','", "title": "','", "allDay": "','", "start": "','", "end": "','", "color": "','", "textColor": "','", "borderColor": "','", "url": "','" }']
        let chavesErradas = ["'id': '","', 'title': '","', 'allDay': '","', 'start': '","', 'end': '","', 'color': '","', 'textColor': '","', 'borderColor': '","', 'url': '","' }"]

        for (c = 0; c < chavesCorretas.length; c++) {
            str = str.replaceAll(chavesErradas[c], chavesCorretas[c])
        }

        return JSON.parse(str)
    })
    .then(resp => {
        const contagem = {
            idTarefas: []
        }

        for (c = 0; c < datas.length; c++) {
            if (c > 0)
                contagem[(datas[c].toISOString().split("T"))[0]] = {
                    Total: 0,
                    Ativas: 0,
                    Encerradas: 0
            }
        }
        
        resp.forEach(e => {
            const data = e['start'].replace(/T\d\d:\d\d:\d\d/, "")
            
            try {
                contagem[data]['Total']++
                if (e.color == "#A5D5EF")
                    contagem[data]['Ativas']++
                if (e.color == "#CCC")
                    contagem[data]['Encerradas']++
                if (data == (datas[1].toISOString().split("T"))[0])
                    contagem['idTarefas'].push(e['id'])
            } catch (error) {
                console.log(contagem, data, e, error)
            }
        })
        return contagem
    })
    
    return result
}

async function getTarefasAtrasadas (params, tarefasAtrasadas) {
    
    const ontem = new Date()
    const passado = new Date(ontem.getFullYear()-10,ontem.getMonth(), ontem.getDate())
    ontem.setDate(ontem.getDate()-1)
    
    const url = 'http://fabioribeiro.eastus.cloudapp.azure.com/adv/tarefas/default.asp'

    const data = {
        bsAdvTarefas: "s",
        bsAdvTarefasTecnica: "",
        bsAdvTarefasDe: `${passado.getDate() < 10 ? "0" + passado.getDate() : passado.getDate()}/${passado.getMonth() < 10 ? "0" + (passado.getMonth() + 1) : passado.getMonth() + 1}/${passado.getFullYear()}`,
        bsAdvTarefasAte: `${ontem.getDate() < 10 ? "0" + ontem.getDate() : ontem.getDate()}/${ontem.getMonth() < 10 ? "0" + (ontem.getMonth() + 1) : ontem.getMonth() + 1}/${ontem.getFullYear()}`,
        bsAdvTarefasTitulo: "",
        bsAdvTarefasTipo: "",
        bsAdvTarefasStatus: "p",
        bsAdvTarefasAgendada: "",
        bsAdvTarefasResponsavel: "",
        bsAdvTarefasCompromisso: "",
        bsAdvTarefasCliente: "",
        bsAdvTarefasCpf: "",
        bsAdvTarefasPauta: "", 
        filtrar: "Filtrar",
    }

    const body = JSON.stringify(data).replaceAll('"','').replaceAll(':','=').replaceAll('{','').replaceAll('}','').replaceAll(',','&') + params

    const result = await fetch(url, {
        method: 'POST',
        headers: new Headers({ 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' }),
        body
    })
    .then(response => response.text())
    .then(response => {
        const parser = new DOMParser()
        const doc = parser.parseFromString(response,'text/html')
        const tarefas = doc.documentElement.querySelectorAll('body > section > section > div.fdt-espaco > div > div.fdt-pg-conteudo > div.table-responsive > table > tbody > tr')

        const lastTask = tarefas[tarefas.length - 1]

        if (lastTask) {
            console.log(lastTask);
            const counter = lastTask.querySelector("td.text-center.fdt-counter")
            tarefasAtrasadas.atrasadas = counter ? counter.innerText : 0
        }

        return tarefasAtrasadas
    })
    
    return result
}


// Barra de Carregamento
function resetBar(setor) {
    percent[setor] = 0
    contIteration[setor] = 0
    const bar = document.querySelector('#bar' + setor)
    bar.value = percent[setor]
}

function finishLoad(bar, interval, setor) {
    interval.clearInterval()
    bar.value = percent[setor]
}

function incrementBar(setor) {
    const bar = document.querySelector("#bar" + setor)
    const unidade = 100 / updateCount[setor]
    percent[setor] += unidade
    bar.value = Math.round(percent[setor])
    contIteration[setor]++
    if (updateCount[setor] == contIteration[setor]) {
        const contentBar = document.querySelector("#contentBar" + setor)
        hiddeContentBar(contentBar)
    }
}

function hiddeContentBar(contentBar) {
    contentBar.style.display = "none"
}

function showContentBar(contentBar, setor) {
    resetBar(setor)
    contentBar.style.display = "flex"
}

function createStyleProgressBar() {
    const style = document.createElement('style')

    style.innerHTML = `
        progress {
            width: 50%;
            height: 20px;
        }

        progress::-webkit-progress-bar {
            background-color: #eee;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        progress::-webkit-progress-value {
            border-radius: 10px;
            transition: width 0.5s;
            background: linear-gradient(to right, #4caf50, #81c784);
        }

        progress::-moz-progress-bar {
            border-radius: 10px;
            transition: width 0.5s;
            background: linear-gradient(to right, #4caf50, #81c784);
        }

        progress::-ms-fill {
            border-radius: 10px;
            transition: width 0.5s;
            background: linear-gradient(to right, #4caf50, #81c784);
        }
    `

    document.head.appendChild(style)
}

function createBar(setor) {
    const maxValueProgressBar = 100
    const contentBar = document.createElement('div')
    const progress = document.createElement('progress')
    const p = document.createElement('p')
    contentBar.append(p)
    contentBar.append(progress)
    contentBar.id = "contentBar" + setor
    progress.id = "bar" + setor
    p.innerHTML="Carregando..."

    p.style.fontSize = "1.5em"
    p.style.color = "#40383A"

    contentBar.style.position = "absolute"
    contentBar.style.flexDirection = "column"
    contentBar.style.justifyContent = "center"
    contentBar.style.alignItems = "center"
    contentBar.style.background = "#CCC"
    contentBar.style.top = "0"
    contentBar.style.left = "0"
    contentBar.style.width = "100%"
    contentBar.style.height = "100%"

    progress.max = maxValueProgressBar
    
    return contentBar
}